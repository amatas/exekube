resource_types:
- name: helm
  type: docker-image
  source:
    repository: linkyard/concourse-helm-resource

resources:
- name: exekube
  type: git
  source:
    uri: https://github.com/ilyasotkov/exekube.git
    branch: develop

- name: rails-react-boilerplate
  type: git
  source:
    uri: https://github.com/ilyasotkov/rails-react-boilerplate.git
    branch: master

- name: rails-react-boilerplate-image
  type: docker-image
  source:
    repository: registry.swarm.pw:443/rails-react-boilerplate
    username: ((docker_registry_username))
    password: ((docker_registry_password))

- name: helm-release
  type: helm
  source:
    cluster_url: ((kube_url))
    cluster_ca: ((kube_ca))
    token: ((kube_token))
    release: rails-app
    repos:
    - name: private
      url: ((private_charts_repo_url))

jobs:
- name: build and deploy the application
  serial: true
  plan:
  - get: exekube
    trigger: false
  - get: rails-react-boilerplate
    trigger: true
  - put: rails-react-boilerplate-image
    params:
      build: rails-react-boilerplate
      tag: rails-react-boilerplate/VERSION
      cache: false
      # cache: true
      # cache_tag: latest
      # tag_as_latest: true
  - put: helm-release
    params:
      chart: private/rails-app
      values: exekube/.concourse/release/values.yaml
      release: exekube/.concourse/release/release.txt
      replace: true
      devel: true
      recreate_pods: false
      override_values:
      - key: image.pullSecret
        value: registry-dockercfg
      - key: image.tag
        path: rails-react-boilerplate/VERSION
      - key: image.repository
        value: registry.swarm.pw/rails-react-boilerplate
